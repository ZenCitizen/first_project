#!/usr/bin/env python
# coding: utf-8

# <div class="alert alert-info">
# –ü—Ä–∏–≤–µ—Ç! –ú–µ–Ω—è –∑–æ–≤—É—Ç –°–≤–µ—Ç–ª–∞–Ω–∞ –ß–∏—Ö –∏ —è –±—É–¥—É –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç. –ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –Ω–µ —É–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ç–æ–±–æ—é –æ—à–∏–±–∫–∏, –∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º –∏ –ø–æ–º–æ—á—å —Ç–µ–±–µ. –ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±—â–∞—Ç—å—Å—è –Ω–∞ ¬´—Ç—ã¬ª. –ù–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —É–¥–æ–±–Ω–æ - –¥–∞–π –∑–Ω–∞—Ç—å, –∏ –º—ã –ø–µ—Ä–µ–π–¥–µ–º –Ω–∞ ¬´–≤—ã¬ª.
# 
# <div class="alert alert-success">
# <b>üëç –£—Å–ø–µ—Ö:</b> –ó–µ–ª—ë–Ω—ã–º —Ü–≤–µ—Ç–æ–º –æ—Ç–º–µ—á–µ–Ω—ã —É–¥–∞—á–Ω—ã–µ –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ–ø–∏—Ä–∞—Ç—å—Å—è –≤ –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö.
# </div>
# <div class="alert alert-warning">
# <b>ü§î –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> –ñ—ë–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω–æ —Ç–æ, —á—Ç–æ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É. –¢—ã –º–æ–∂–µ—à—å —É—á–µ—Å—Ç—å —ç—Ç–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É–¥—É—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π –∏–ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–µ–∫—Ç —Å–µ–π—á–∞—Å (–æ–¥–Ω–∞–∫–æ —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
# </div>
# <div class="alert alert-danger">
# <b>üòî –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</b> –ö—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º –≤—ã–¥–µ–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –±–µ–∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö, —è –Ω–µ —Å–º–æ–≥—É –ø—Ä–∏–Ω—è—Ç—å –ø—Ä–æ–µ–∫—Ç :(
# </div>
# <div class="alert alert-info">
# <b>üëÇ –°–æ–≤–µ—Ç:</b> –ö–∞–∫–∏–µ-—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
# </div>
# –î–∞–≤–∞–π —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º –≤ –¥–∏–∞–ª–æ–≥–µ: –µ—Å–ª–∏ —Ç—ã —á—Ç–æ-—Ç–æ –º–µ–Ω—è–µ—à—å –≤ –ø—Ä–æ–µ–∫—Ç–µ –ø–æ –º–æ–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º ‚Äî –ø–∏—à–∏ –æ–± —ç—Ç–æ–º.
# –ú–Ω–µ –±—É–¥–µ—Ç –ª–µ–≥—á–µ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ —Ç—ã –≤—ã–¥–µ–ª–∏—à—å —Å–≤–æ–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:
# <div class="alert alert-info"> <b>üéì –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞:</b> –ù–∞–ø—Ä–∏–º–µ—Ä, –≤–æ—Ç —Ç–∞–∫.</div>
# –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞–π, –Ω–µ –∏–∑–º–µ–Ω—è–π –∏ –Ω–µ —É–¥–∞–ª—è–π –º–æ–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –í—Å—ë —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –±—ã—Å—Ç—Ä–µ–µ.
#  </div>

# –í —ç—Ç–æ–π —á–∞—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤–∞–º –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Jupyter Notebook. –≠—Ç–∏ –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—Ç –≤—Ä—É—á–Ω—É—é, –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º. 
# 
# –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö —Å—Ö–µ–º—ã `stackoverflow`. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ —Å –ø–æ–º–æ—â—å—é SQLAlchemy. –í—Å–ø–æ–º–Ω–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏–∑ [—É—Ä–æ–∫–∞ –ø—Ä–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤](https://practicum.yandex.ru/learn/data-analyst-plus/courses/96ccbf7a-b65d-4f51-b5f3-18360ad1e301/sprints/6116/topics/27f7c9a7-a474-4a82-8392-b3f069b26f69/lessons/e12d84bb-ffa8-490c-8bde-0935d86ceccb/). –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –∏ –≤—ã–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã –Ω–∞–π–¥—ë—Ç–µ –∏ –≤ —ç—Ç–æ–π —Ç–µ—Ç—Ä–∞–¥–∫–µ. 
# 
# –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ –∏—Ö. –ù–∞ —á–∞—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º, –∞ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è. –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–Ω–æ –≤—ã–≥—Ä—É–∑–∏—Ç—å –≤ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º. 
# 
# –ß—Ç–æ–±—ã –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—ã–ª–æ –ª–µ–≥—á–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, –º—ã –¥–æ–±–∞–≤–∏–ª–∏ –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–¥–∞–Ω–∏—é –Ω–µ–±–æ–ª—å—à–æ–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã. –í –∑–∞–ø—Ä–æ—Å–∞—Ö –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–æ–ª–µ–π.

# In[22]:


import pandas as pd
import matplotlib.pyplot as plt
from sqlalchemy import create_engine 
import seaborn as sns


# ### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö `data-analyst-advanced-sql`
# –≠—Ç–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ö–µ–º—É `stackoverflow`, —Å –∫–æ—Ç–æ—Ä–æ–π –≤—ã –±—É–¥–µ—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ

# In[23]:


db_config = {
    'user': 'praktikum_student', # –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    'pwd': 'Sdf4$2;d-d30pp', # –ø–∞—Ä–æ–ª—å
    'host': 'rc1b-wcoijxj3yxfsf3fs.mdb.yandexcloud.net',
    'port': 6432, # –ø–æ—Ä—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    'db': 'data-analyst-advanced-sql' # –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
}  

connection_string = 'postgresql://{}:{}@{}:{}/{}'.format(
    db_config['user'],
    db_config['pwd'],
    db_config['host'],
    db_config['port'],
    db_config['db'],
)


# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

# In[24]:


engine = create_engine(connection_string) 


# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
# 
# `sample_df` —è–≤–ª—è–µ—Ç—Å—è pandas-–¥–∞—Ç–∞—Ñ—Ä–µ–π–º–æ–º.

# In[25]:


query = '''
SELECT *
FROM stackoverflow.users
LIMIT 10;
'''

sample_df = pd.read_sql_query(query, con=engine) 


# In[26]:


sample_df


# <div class="alert alert-success">
# <b>üëç –£—Å–ø–µ—Ö:</b> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –Ω—É–∂–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —Å–æ–∑–¥–∞–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –µ–≥–æ —Ä–∞–±–æ—Ç–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
# </div>

# # –ó–∞–¥–∞–Ω–∏–µ 1

# –í—ã–≤–µ–¥–∏—Ç–µ –æ–±—â—É—é —Å—É–º–º—É –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ—Å—Ç–æ–≤ –∑–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü 2008 –≥–æ–¥–∞. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –∫–∞–∫–æ–π-–ª–∏–±–æ –º–µ—Å—è—Ü –≤ –±–∞–∑–µ –Ω–µ—Ç, —Ç–∞–∫–æ–π –º–µ—Å—è—Ü –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ —É–±—ã–≤–∞–Ω–∏—é –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.

# | month_date  | total_views |
# | ------------- | ------------- |
# | 2008-09-01  | 452928568  |
# | 2008-10-01  | 365400138  |
# | ...         | ... |

# In[27]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
SELECT cast(date_trunc('month', creation_date) AS date) month_date, 
	   sum(views_count) views_total
FROM stackoverflow.posts p 
WHERE EXTRACT (YEAR FROM creation_date) = '2008'
GROUP BY month_date
ORDER BY views_total DESC
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task1 = pd.read_sql_query(query, con=engine) 
df_task1


#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ! –ú–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –ø–æ–ª—å–∑—É–µ—à—å—Å—è –∞–ª–∏–∞—Å–∞–º–∏ –ø—Ä–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ, –≤–º–µ—Å—Ç–æ  CAST(DATE_TRUNC('month', creation_date) AS date) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DATE_TRUNC('month', creation_date)::date
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —É—Å–µ—á–µ–Ω–∏—è –¥–∞—Ç—ã, –∞ –∑–∞—Ç–µ–º —Å–≥—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ.
# </details>

# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É. –û—Ç–ª–∏—á–∞—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ä–∞–∑–Ω—ã–µ –º–µ—Å—è—Ü—ã? –° —á–µ–º –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã –æ—Ç–ª–∏—á–∏—è?

# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
#     
# –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±—ã–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤ 2008 –≥–æ–¥–∞. –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–ª—å–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –∫–æ–ª-–≤–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –≤ —Å–µ–Ω—Ç—è–±—Ä–µ —Å –¥–∞–ª—å–Ω–µ–π—à–∏–º —Å–Ω–∏–∂–µ–Ω–∏–µ–º. –î—É–º–∞—é —ç—Ç–∏ –∫–æ–ª–µ–±–∞–Ω–∏—è —Å–≤—è–∑–∞–Ω—ã —Å –Ω–∞—á–∞–ª–æ–º —É—á–µ–±–Ω–æ–≥–æ –≥–æ–¥–∞. –õ–µ—Ç–æ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, –∞ –≤ —Å–µ–Ω—Ç—è–±—Ä–µ –≤—Å–µ, –∫—Ç–æ –Ω–∞—á–∞–ª–∏ —É—á–µ–±–Ω—ã–π –≥–æ–¥ –ø–æ IT —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º –Ω–∞—á–∏–Ω–∞—é—Ç –∏—Å–∫–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —Å–≤–æ–∏—Ö –∑–∞–¥–∞—á
#         
# </div>

#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# # –ó–∞–¥–∞–Ω–∏–µ 2

# –í—ã–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤ –ø–µ—Ä–≤—ã–π –º–µ—Å—è—Ü –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–≤–∫–ª—é—á–∞—è –¥–µ–Ω—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏) –¥–∞–ª–∏ –±–æ–ª—å—à–µ 100 –æ—Ç–≤–µ—Ç–æ–≤. –í–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–≤–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω–µ —É—á–∏—Ç—ã–≤–∞–π—Ç–µ. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π `user_id`. –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –ø–æ–ª—é —Å –∏–º–µ–Ω–∞–º–∏ –≤ –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ.

# | display_name | count |
# | ------------ | ----- |
# | 1800 INFORMATION | 1 |
# | Adam Bellaire | 1 |
# | Adam Davis | 1 |
# | ... | ... |

# In[28]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
WITH raw AS 
	(SELECT u.id user_id, u.creation_date :: date, u.display_name,
		   p.id post_id, 
		   p.creation_date :: date post_dt
	FROM stackoverflow.posts p
	JOIN stackoverflow.users u ON u.id = p.user_id
	WHERE post_type_id IN (SELECT id 
							FROM stackoverflow.post_types 
							WHERE TYPE = 'Answer')
	AND p.creation_date BETWEEN u.creation_date AND u.creation_date + INTERVAL '30 days')
SELECT display_name, count(DISTINCT user_id) 
FROM raw
GROUP BY display_name
HAVING count(post_id) > 100
ORDER BY display_name

'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task2 = pd.read_sql_query(query, con=engine) 
df_task2


#  <div class="alert alert-danger">
# <s> <b>üòî –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</b> –í —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—è—Ü–∞—Ö —Ä–∞–∑–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π, –≤ –æ–∫—Ç—è–±—Ä–µ - 31, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å INTERVAL '1 month', –∏ –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –∞ –ø—Ä–æ—Å—Ç–æ –æ–±—ä–µ–¥–∏–Ω–∏–≤ —Å—Ä–∞–∑—É 3 –∏ –≤—ã–±–∏—Ä–∞—è –∏–∑ –Ω–∏—Ö –¥–∞–Ω–Ω—ã–µ</s>
#  </div>

# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
#     
# –ü—Ä–∏–Ω—è—Ç–æ, –∑–∞–º–µ–Ω–∏–ª–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ—Å—è—Ü, –∏ —É–±—Ä–∞–ª–∞ –æ–¥–Ω—É –ª–∏—à–Ω—é—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π))) 
# –°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!
# </div>

# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –í–∞–º –Ω—É–∂–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü ‚Äî –∏–∑—É—á–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–∞–∑—ã. –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –∫ –¥–∞—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ INTERVAL, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫: <–¥–∞—Ç–∞> + INTERVAL '1¬†year 2 months 3 days'
# .</details>

# –ö–∞–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ –Ω–∞–±–ª—é–¥–∞—é—Ç—Å—è –≤ –¥–∞–Ω–Ω—ã—Ö? –û —á—ë–º –æ–Ω–∏ –≥–æ–≤–æ—Ä—è—Ç?

# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
#     
# –°–∫—Ä–∏–ø—Ç –≤—ã–¥–∞–ª –≤—Å–µ–≥–æ 74 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö display_name. 
# –°—É–¥—è –ø–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ display_name –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ –≤–≤–µ–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –≥–¥–µ —Ç–æ —é–∑–µ—Ä—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–ª–Ω—ã–µ –∏–º–µ–Ω–∞, –≥–¥–µ —Ç–æ —Ç–æ–ª—å–∫–æ –∏–º—è, –≥–¥–µ —Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–±–æ—Ä –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä. –¢–∞–∫ –∂–µ display_name –º–æ–≥—É—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è —É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —é–∑–µ—Ä–æ–≤.         
# </div>

#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# # –ó–∞–¥–∞–Ω–∏–µ 3

# –í—ã–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –∑–∞ 2008 –≥–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º. –û—Ç–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —Å–µ–Ω—Ç—è–±—Ä–µ 2008 –≥–æ–¥–∞ –∏ —Å–¥–µ–ª–∞–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ—Å—Ç –≤ –¥–µ–∫–∞–±—Ä–µ —Ç–æ–≥–æ –∂–µ –≥–æ–¥–∞. –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –º–µ—Å—è—Ü–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é.

# | month | count |
# | ------|------ |
# | 2008-12-01 | 17641 |
# | 2008-11-01 | 18294 |
# | ... | ... |

# In[29]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
-- users who registered 09/2008						
WITH users as
	(SELECT id user_id, creation_date :: date
	FROM stackoverflow.users
	WHERE DATE_TRUNC('month', creation_date) = '2008-09-01'),
-- users who had posts at 12/2008	
users_list AS 	
	(SELECT DISTINCT u.user_id
	FROM users u
	JOIN stackoverflow.posts p ON u.user_id = p.user_id 
	WHERE DATE_TRUNC('month', p.creation_date) = '2008-12-01')
-- count of posts by users_list
SELECT cast(date_trunc('month', p.creation_date) AS date) month_date, count(p.id)
FROM users_list u
JOIN stackoverflow.posts p ON u.user_id = p.user_id 
GROUP BY month_date
ORDER BY month_date DESC 
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task3 = pd.read_sql_query(query, con=engine) 
df_task3


# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —Å–µ–Ω—Ç—è–±—Ä–µ 2008 –≥–æ–¥–∞ –∏ –æ—Å—Ç–∞–≤–∏–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ—Å—Ç –≤ –¥–µ–∫–∞–±—Ä–µ. –ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å—Ä–µ–∑–∞ –∏ –ø–æ—Å—á–∏—Ç–∞–π—Ç–µ –ø–æ—Å—Ç—ã –ø–æ –º–µ—Å—è—Ü–∞–º.</details>

# –ò–∑—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ: –µ—Å—Ç—å –ª–∏ –≤ –Ω–∏—Ö –∞–Ω–æ–º–∞–ª–∏–∏? –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ, –ø–æ—á–µ–º—É –º–æ–≥–ª–∏ –ø–æ—è–≤–∏—Ç—å—Å—è –∞–Ω–æ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
# 
# –ü–æ –¢–ó –º—ã –≤—ã–≥—Ä—É–∂–∞–ª–∏ —é–∑–µ—Ä–æ–≤, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–≤—à–∏—Ö—Å—è –≤ –±–∞–∑–µ –≤ —Å–µ–Ω—Ç—è–±—Ä–µ 2008 –≥–æ–¥–∞, –Ω–æ –ø–æ –≤—ã–≥—Ä—É–∑–∫–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á—Ç–æ —É –Ω–∏—Ö –±—ã–ª–∏ –ø–æ—Å—Ç—ã —É–∂–µ –≤ –∞–≤–≥—É—Å—Ç–µ. –Ø –Ω–µ –∑–Ω–∞–∫–æ–º–∞ —Å –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ stackoverflow, –Ω–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é, —á—Ç–æ –ª—é–¥—è–º –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è user_id –ø—Ä–∏ –ª—é–±–æ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–µ —Å —Å–∞–π—Ç–æ–º, –∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ä–µ–≥ –¥–∞–Ω–Ω—ã—Ö. –ò –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–π user_id –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.     
# </div>

# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# # –ó–∞–¥–∞–Ω–∏–µ 4

# –ò—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å—Ç–∞—Ö, –≤—ã–≤–µ–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–π:
# 
# - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø–∏—Å–∞–ª –ø–æ—Å—Ç;
# - –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞;
# - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Å—Ç–∞;
# - —Å—É–º–º—É –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –ø–æ—Å—Ç–æ–≤ –∞–≤—Ç–æ—Ä–∞ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º.
# 
# –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ –¥–∞–Ω–Ω—ã–µ –æ–± –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ‚Äî –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞.

# | user_id | creation_date | views_count | cumulative_count |
# | ------ | -------------- | ----------- | ---------------- |
# | 1 | 2008-07-31 23:41:00  | 480476   | 480476  |
# | 1 | 2008-07-31 23:55:38  | 136033 | 616509  | 
# | 1 | 2008-07-31 23:56:41  | 0 |  616509  |
# | ... | ... | ... | ... |
# | 2 | 2008-07-31 23:56:41 | 79087  | 79087 |
# | 2 | 2008-08-01 05:09:56 | 65443 | 144530 |
# | ... | ...  | ...  | ...  |

# In[30]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
SELECT user_id, creation_date, views_count, 
	   sum(views_count) OVER (PARTITION BY user_id ORDER BY creation_date) cumulative_count
FROM stackoverflow.posts
ORDER BY user_id, creation_date
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task4 = pd.read_sql_query(query, con=engine) 
df_task4


# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ! –° –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π –≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –î–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Å—É–º–º—ã —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.
# </details>

# # –ó–∞–¥–∞–Ω–∏–µ 5

# –ù–∞–π–¥–∏—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥–µ–Ω—å –∑–∞ –∞–≤–≥—É—Å—Ç 2008 –≥–æ–¥–∞. –û—Ç–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ –±–æ–ª—å—à–µ 120 –ø–æ—Å—Ç–æ–≤ –∑–∞ –∞–≤–≥—É—Å—Ç. –î–Ω–∏ –±–µ–∑ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –Ω–µ —É—á–∏—Ç—ã–≤–∞–π—Ç–µ. 
# 
# –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å—Ç–æ–≤. –ó–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –Ω–µ –æ–∫—Ä—É–≥–ª—è—Ç—å.

# | user_id | avg_daily |
# | ------- | --------- |
# | 116     | 4.777778  |
# | 234     | 5.208333  |
# | ...     | ... |

# In[31]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
WITH raw AS 
	(SELECT user_id, creation_date :: date, count(id) daily_count
	FROM stackoverflow.posts p 
	WHERE user_id IN (SELECT user_id
		FROM stackoverflow.posts
		WHERE DATE_TRUNC('month', creation_date) = '2008-08-01'
		GROUP BY user_id
		HAVING count(id) > 120)
	AND DATE_TRUNC('month', creation_date) = '2008-08-01'
	GROUP BY 1, 2)
SELECT user_id, avg(daily_count) avg_daily
FROM raw
GROUP BY user_id
ORDER BY avg_daily
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task5 = pd.read_sql_query(query, con=engine) 
df_task5


# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–ø–∏—Å–∞–ª–∏ –±–æ–ª–µ–µ 120 –ø–æ—Å—Ç–æ–≤ –∑–∞ –∞–≤–≥—É—Å—Ç. –ò—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Å—Ä–µ–∑–∞, –Ω–∞–π–¥–∏—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –Ω—É–∂–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –¥–Ω–∏ –∞–≤–≥—É—Å—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å. –í –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ —Å–≥—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –Ω–∞–π–¥–∏—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –Ω–∏—Ö —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤.
# </details>

# # –ó–∞–¥–∞–Ω–∏–µ 6

# –°–∫–æ–ª—å–∫–æ –≤ —Å—Ä–µ–¥–Ω–µ–º –¥–Ω–µ–π –≤ –ø–µ—Ä–∏–æ–¥ —Å 1 –ø–æ 7 –¥–µ–∫–∞–±—Ä—è 2008 –≥–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∏ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π? –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–±–µ—Ä–∏—Ç–µ –¥–Ω–∏, –≤ –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω –∏–ª–∏ –æ–Ω–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ—Å—Ç. –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ–¥–Ω–æ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ ‚Äî –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –æ–∫—Ä—É–≥–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. 

# | result |
# | -----  |
# | <—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ> |

# In[32]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
SELECT round(avg(days))
FROM (WITH raw AS
		(SELECT DISTINCT user_id, creation_date :: date AS dt
		FROM stackoverflow.posts p 
		WHERE creation_date :: date BETWEEN to_date('01122008', 'ddmmyyyy') AND to_date('07122008', 'ddmmyyyy'))
	SELECT user_id, count(dt) days
	FROM raw
	GROUP BY user_id) x
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task6 = pd.read_sql_query(query, con=engine) 
df_task6


# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –ü–æ—Å—á–∏—Ç–∞–π—Ç–µ, —Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π –±—ã–ª–æ —É –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
# </details>

# –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É ‚Äî –∫–∞–∫–∏–µ –≤—ã–≤–æ–¥—ã –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?

# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
# 
# –í —Å—Ä–µ–¥–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∏ 2 –¥–Ω—è –∏–∑ 7 –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ. –£—á–∏—Ç—ã–≤–∞—è —á—Ç–æ —ç—Ç–æ –Ω–µ –ø–µ—Ä–∏–æ–¥ –ø–∏–∫–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∞–π—Ç–∞ (—Å—É–¥—è –ø–æ –¥–∞–Ω–Ω—ã–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç —Å —Å–∞–π—Ç–æ–º –≤ —Å–µ–Ω—Ç—è–±—Ä–µ) –¥—É–º–∞—é –Ω–µ–ø–ª–æ—Ö–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å.
# </div>

# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# # –ó–∞–¥–∞–Ω–∏–µ 7

# –í—ã–≤–µ–¥–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞. –û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤—ã–≤–æ–¥ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
# 
# –î–æ–±–∞–≤—å—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü—É –Ω–æ–≤–æ–µ –ø–æ–ª–µ: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ –≤ –Ω—ë–º –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π. –ï—Å–ª–∏ —Ç–∞–∫–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ—Ç, —É–∫–∞–∂–∏—Ç–µ `NULL`.  Python –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ–Ω—è–µ—Ç `NULL` –Ω–∞ `None`, –Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è `None` –≤–∞–º –Ω–µ –Ω—É–∂–Ω–æ.
# 
# –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ –æ–±—Ä–∞–∑–µ—Ü —Ç–∞–±–ª–∏—Ü—ã: –¥–ª—è –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –ø–æ—Å—Ç–æ–≤ –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–µ—Ç, –Ω–æ, –Ω–∞—á–∏–Ω–∞—è —Å —Ç—Ä–µ—Ç—å–µ–≥–æ –ø–æ—Å—Ç–∞, –≤ –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤—Ö–æ–¥–∏—Ç –Ω—É–∂–Ω—ã–π –º–µ—Å—è—Ü. –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–µ—Ä–≤—ã–µ –¥–≤–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—è `second_last_month` —Ç–æ–∂–µ –≤–æ–π–¥—ë—Ç `NULL`.

# | user_id | creation_date | second_last_month |
# | ------- | ------------- | ----------------- |
# | 1       | 2008-07-31 23:41:00 | None |
# | 1       | 2008-07-31 23:55:38 | None |
# | 1       | 2008-07-31 23:56:41 | July |
# | 1       | 2008-08-04 02:45:08 | July |
# | 1       | 2008-08-04 04:31:03 | July |
# | 1       | 2008-08-04 08:04:42 | August |
# | ... | ... | ... |

# In[33]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
SELECT user_id, creation_date post_dt,
	   to_char(lag(creation_date, 2, NULL) OVER (PARTITION BY user_id ORDER BY creation_date), 'Month') second_last_month
FROM stackoverflow.posts p 
ORDER BY user_id
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task7 = pd.read_sql_query(query, con=engine) 
df_task7


#  <div class="alert alert-danger">
# <s> <b>üòî –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:</b> –ê –∑–∞—á–µ–º –∑–¥–µ—Å—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞? –•–æ—Ä–æ—à–∞—è –∏–¥–µ—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å to_char, –Ω–æ —Å–¥–µ–ª–∞–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º</s>
#  </div>

# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
# 
# –í –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —Ç–∞–∫–∞—è –∂–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –∏ —è –ø–æ–¥—É–º–∞–ª–∞ —á—Ç–æ –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–µ–ª—å–∑—è –æ–±–µ—Ä–Ω—É—Ç—å –≤ to_char, –Ω–æ –≤–∏–¥–∏–º–æ –±—ã–ª–∞ –∫–∞–∫–∞—è —Ç–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ò—Å–ø—Ä–∞–≤–∏–ª–∞, —É–±—Ä–∞–ª–∞ –ª–∏—à–Ω—é—é –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é))) –°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏! 
# </div>

# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ! –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π –æ—à–∏–±–∫–∏, –∏–Ω–æ–≥–¥–∞ –±—ã–≤–∞—é—Ç –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –∏–ª–∏ –ø—É—Ç–∞–Ω–∏—Ü–∞ —Å–æ —Å–∫–æ–±–∫–∞–º–∏
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –Ω—É–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–∞–º –ø–æ–º–æ–∂–µ—Ç –∞–Ω–∞–ª–æ–≥ —É—Å–ª–æ–≤–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ SQL: CASE <–ø–æ–ª–µ> WHEN <—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ> THEN <–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ> END.
# </details>

# # –ó–∞–¥–∞–Ω–∏–µ 8

# –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –∞–Ω–∞–ª–æ–≥ Retention Rate –ø–æ –º–µ—Å—è—Ü–∞–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π StackOverflow. –û–±—ä–µ–¥–∏–Ω–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–æ–≥–æ—Ä—Ç—ã –ø–æ –º–µ—Å—è—Ü—É –∏—Ö –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞. –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ –ø–æ –Ω–∞–ª–∏—á–∏—é –ø–æ—Å—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ. 

# | cohort_dt | session_date | users_cnt | cohort_users_cnt | retention_rate |
# | --- | --- | --- | --- | --- |
# | 2008-07-01 00:00:00 | 2008-07-01 00:00:00 | 3 | 3 | 100 |
# | 2008-07-01 00:00:00 | 2008-08-01 00:00:00 | 2 | 3 | 66,67 |
# | 2008-07-01 00:00:00 | 2008-09-01 00:00:00 | 1 | 3 | 33,33 |
# | 2008-07-01 00:00:00 | 2008-10-01 00:00:00 | 2 | 3 | 66,67 |
# | 2008-07-01 00:00:00 | 2008-11-01 00:00:00 | 1 | 3 | 33,33 |
# | 2008-07-01 00:00:00 | 2008-12-01 00:00:00 | 2 | 3 | 66,67 |
# | 2008-08-01 00:00:00 | 2008-08-01 00:00:00 | 2151 | 2151 | 100 |
# | ... | ... | ... | ... | ... |

# In[34]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
WITH cohorts as
	(SELECT x.*, count(user_id) OVER (PARTITION BY cohort_dt) cohort_users_cnt
	FROM (SELECT DISTINCT user_id, 
		   		 CAST(date_trunc('month', min(creation_date) OVER (PARTITION BY user_id ORDER BY creation_date)) AS date) cohort_dt
		  FROM stackoverflow.posts) x),
sessions as
	(SELECT user_id, cast(date_trunc('month', creation_date) AS date) session_dt
	FROM stackoverflow.posts 
	GROUP BY 1, 2)
SELECT c.cohort_dt, 
	   s.session_dt, 
	   count(c.user_id) users_cnt,
	   cohort_users_cnt, 
	   round(count(c.user_id) * 100.0 / cohort_users_cnt, 2) retention_rate 
FROM cohorts c
JOIN sessions s ON c.user_id = s.user_id
GROUP BY 1, 2, 4
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task8 = pd.read_sql_query(query, con=engine) 
df_task8


#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –í—Å–ø–æ–º–Ω–∏—Ç–µ, –∫–∞–∫ –≤—ã–≥–ª—è–¥–µ–ª –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ Retention Rate –≤ —Ç–µ–æ—Ä–∏–∏. –°–æ–∑–¥–∞–π—Ç–µ –¥–≤–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:¬†`profile`¬†–∏¬†`sessions`¬†(–≤ –Ω–µ–π –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö), –∞ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ.
# 
# –í–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ¬†`profile`¬†–≤–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —Ç—Ä–∏ –ø–æ–ª—è:
# 
# - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è;
# - –¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É—Å–µ—á—ë–Ω–Ω–∞—è –¥–æ –º–µ—Å—è—Ü–∞ (–ø—Ä–∏–∑–Ω–∞–∫ –Ω–∞—á–∞–ª–∞ –∫–æ–≥–æ—Ä—Ç—ã);
# - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —ç—Ç–æ–π –∫–æ–≥–æ—Ä—Ç—ã.
# </details>

# –ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É Retention Rate. –ö–∞–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –Ω–µ–æ–±—ã—á–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–æ—Å—å –≤—ã—è–≤–∏—Ç—å? –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—ã –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–∞—Ö.

# In[35]:


# –ø–æ—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É Retention Rate
# —Å–æ–∑–¥–∞—ë–º —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
retention = df_task8.pivot('cohort_dt', 'session_dt', 'retention_rate')
retention.index = [str(x)[0:10] for x in retention.index]
retention.columns = [str(x)[0:10] for x in retention.columns]

# —Å—Ç—Ä–æ–∏–º —Ö–∏—Ç–º—ç–ø
plt.figure(figsize=(10, 10)) # –∑–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
sns.heatmap(retention, # –¥–∞—Ç–∞—Ñ—Ä–µ–π–º —Å –¥–∞–Ω–Ω—ã–º–∏
            annot=True, # –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏
            fmt='') # –∑–∞–¥–∞—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
plt.title('–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞') # –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
plt.show()


#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# In[36]:


# –æ–ø–∏—à–∏—Ç–µ –∞–Ω–æ–º–∞–ª–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–∏–µ –Ω–µ–æ–±—ã—á–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è –∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—ã


# <div class="alert alert-block alert-info"><b> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞</b> 
# 
# –ü–æ —Ö–∏—Ç–º—ç–ø—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—é–ª—å—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –∞–Ω–æ–º–∞–ª—å–Ω–æ–π, –Ω–æ —Ç.–∫. –≤ –∏—é–ª–µ —É –Ω–∞—Å –±—ã–ª–∞ –Ω–µ–±–æ–ª—å—à–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —ç—Ç–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤–≤–∏–¥—É –Ω–µ—Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã. 
#  
# –ü–æ –æ—Å—Ç–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º –≤–∏–¥–Ω–æ —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–∞ –≤—Ç–æ—Ä–æ–π –º–µ—Å—è—Ü —Å –∞–≤–≥—É—Å—Ç–∞ –ø–æ –Ω–æ—è–±—Ä—å, —Å 73% –¥–æ 40% —Å–æ–æ—Ç–≤–µ—Å—Ç–≤–µ–Ω–Ω–æ. 
# </div>

#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# # –ó–∞–¥–∞–Ω–∏–µ 9
# 

# –ù–∞ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –º–µ–Ω—è–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –µ–∂–µ–º–µ—Å—è—á–Ω–æ —Å 1 —Å–µ–Ω—Ç—è–±—Ä—è –ø–æ 31 –¥–µ–∫–∞–±—Ä—è 2008 –≥–æ–¥–∞? –û—Ç–æ–±—Ä–∞–∑–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:
# 
# - –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞;
# - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü;
# - –ø—Ä–æ—Ü–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º.
# 
# –ï—Å–ª–∏ –ø–æ—Å—Ç–æ–≤ —Å—Ç–∞–ª–æ –º–µ–Ω—å—à–µ, –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º, –µ—Å–ª–∏ –±–æ–ª—å—à–µ ‚Äî –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º. –û–∫—Ä—É–≥–ª–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –¥–æ –¥–≤—É—Ö –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.
# 
# –ù–∞–ø–æ–º–Ω–∏–º, —á—Ç–æ –ø—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ –≤ PostgreSQL –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–ª—É—á–∏—Ç—Å—è —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –æ–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Ü–µ–ª–æ–≥–æ –≤–Ω–∏–∑. –ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –¥–µ–ª–∏–º–æ–µ –≤ —Ç–∏–ø `numeric`.

# | creation_month | posts_count | percentage |
# | -------------- | ----------- | ---------- |
# | 9 | 70731 | Nan |
# | 10 | 63102 | -10.33 |
# | ... | ... | ... |

# In[37]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
SELECT month_number, posts_cnt, round((difference_perc * 100), 2) percentage
FROM 
	(WITH raw AS 
		(SELECT EXTRACT(MONTH FROM (cast(date_trunc('month', creation_date) AS date))) month_number, count(id) posts_cnt
		FROM stackoverflow.posts
		WHERE creation_date :: date BETWEEN to_date('01092008', 'ddmmyyyy') AND to_date('31122008', 'ddmmyyyy')
		GROUP BY 1
		ORDER BY 1)
	SELECT *, lag(posts_cnt) OVER (ORDER BY month_number),
		   (posts_cnt - lag(posts_cnt) OVER (ORDER BY month_number)) difference,
		   (posts_cnt - lag(posts_cnt) OVER (ORDER BY month_number)) :: numeric / lag(posts_cnt) OVER (ORDER BY month_number) difference_perc
	FROM raw) x
'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task9 = pd.read_sql_query(query, con=engine) 
df_task9


#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –≠—Ç—É –∑–∞–¥–∞—á—É —Å—Ç–æ–∏—Ç –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∑–∏—Ç –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤. –ó–∞—Ç–µ–º –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–µ—Ä–Ω—ë—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü, –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç.
# </details>

# –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ—Å—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º.

# In[38]:


# –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –∫—Ä—É–≥–æ–≤—É—é –¥–∏–∞–≥—Ä–∞–º–º—É —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ—Å—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º

posts_cnt = df_task9['posts_cnt']
labels = df_task9['month_number']

def make_autopct(values):
    def my_autopct(pct):
        total = sum(values)
        val = int(round(pct*total/100.0))
        return '{p:.2f}%  ({v:d})'.format(p=pct,v=val)
    return my_autopct

# —Å—Ç—Ä–æ–∏–º piechart
plt.figure(figsize=(8, 8)) # –∑–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞
plt.title('–ö–æ–ª-–≤–æ –ø–æ—Å—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º') # –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞

plt.pie(posts_cnt, labels=labels, autopct=make_autopct(posts_cnt))
plt.show()


#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# # –ó–∞–¥–∞–Ω–∏–µ 10

# –í—ã–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è. –í—ã–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ –æ–∫—Ç—è–±—Ä—å 2008 –≥–æ–¥–∞ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ:
# 
# - –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏;
# - –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ.

# | week_creation | creation_date |
# | ------------- | ------------- |
# | 40 | 2008-10-05 09:00:58 |
# | 41 | 2008-10-12 21:22:23 |
# | ... | ... |

# In[39]:


# –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
query = '''
SELECT DISTINCT date_part('week', creation_date) week_num,
	   max(creation_date) OVER (PARTITION BY date_part('week', creation_date))
FROM stackoverflow.posts 
WHERE date_trunc('month', creation_date) = '2008-10-01' 
AND user_id IN (SELECT user_id
				FROM stackoverflow.posts
				GROUP BY user_id
				ORDER BY count(id) DESC
				LIMIT 1)

'''

# –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
df_task10 = pd.read_sql_query(query, con=engine) 
df_task10


#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –í—Å–µ –≤–µ—Ä–Ω–æ!
#  </div>

# <details>
# 
# <summary>–ü–æ–¥—Å–∫–∞–∑–∫–∞</summary>
# –î–µ–∫–æ–º–ø–æ–∑–∏—Ä—É–π—Ç–µ –∑–∞–¥–∞—á—É:
# 1) –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤. 2) –ù–∞–π–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏. 
# 3) –û—Ç–æ–±—Ä–∞–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ—Å—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–ª—è —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–∫–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.
# </details>

#  <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –£ —Ç–µ–±—è —Ö–æ—Ä–æ—à–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –º–æ–ª–æ–¥–µ—Ü! –ù–æ —Å—Ç–∞—Ä–∞–π—Å—è –∏—Å–∫–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
#  </div>

# <div class="alert alert-success">
#  <b>üëç –£—Å–ø–µ—Ö:</b> –¢–µ–ø–µ—Ä—å –≤—Å–µ –æ—Ç–ª–∏—á–Ω–æ, —Å—É–ø–µ—Ä! –£ —Ç–µ–±—è –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è. –ü–æ—Å—Ç–∞—Ä–∞–π—Å—è –≤—Å–µ –∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, —É—á–∏—Å—å –ø–æ–Ω–∏–º–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞, –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏, –±—ã–≤–∞–µ—Ç –∏ –≤ —Ç—Ä–∏–ª–ª–∏–æ–Ω—ã —Å—Ç—Ä–æ–∫, –º–∏–ª–ª–∏–æ–Ω—ã –≤–æ–æ–±—â–µ –æ–±—ã—á–Ω–æ–µ –¥–µ–ª–æ, –∏ –Ω–∞ —Ç–∞–∫–∏—Ö –æ–±—ä–µ–º–∞—Ö –ª–∏—à–Ω—è—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ –º–æ–≥—É—Ç –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –∏ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –±–æ–ª—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤, —á–µ–º –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞. –ù–∞ —ç—Ç–æ —Ç–∞–∫ –∂–µ –æ–±—Ä–∞—â–∞—é—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è—Ö, –≤–∞–∂–Ω–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∞ –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ. –ú—ã –∑–¥–µ—Å—å –∫–∞–∫ —Ä–∞–∑ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ –±—ã –ø–æ–º–æ—á—å —Ç–µ–±–µ –≤ —ç—Ç–æ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è))) –ò –º–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ SQL  <a href='https://sql-ex.ru'> —Ç—ã—Ü</a>, <a href='https://pgexercises.com'> —Ç—ã—Ü</a>, <a href='https://sql-academy.org'> —Ç—ã—Ü</a>, <a href='https://stepik.org/course/63054/info'> —Ç—ã—Ü</a>, <a href='https://Itresume.ru'> —Ç—ã—Ü</a>
#  </div>

# In[ ]:




